name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          dist/
          icon.png
          package.json
          README.md
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./release
        
    - name: Create release package
      run: |
        cd release
        zip -r ../orca-W95-theme-${{ github.ref_name }}.zip .
        
    - name: Get version from package.json
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Orca W95 Theme Plugin ${{ github.ref_name }}
        body: |
          ## 🎨 Orca W95 Theme Plugin ${{ github.ref_name }}
          
          ### 📦 安装包内容
          - `index.js` - 插件主文件
          - `css/` - 主题样式文件
            - `theme.css` - 主主题样式
            - `theme2.css` - 主题2样式
          - `icon.png` - 插件图标
          - `package.json` - 插件配置
          - `README.md` - 使用说明
          
          ### 🚀 安装方法
          1. 下载 `orca-W95-theme-${{ github.ref_name }}.zip`
          2. 解压到 Orca Note 插件目录
          3. 重启 Orca Note
          
          ### ✨ 功能特性
          - 🎨 W95 风格主题
          - 🔄 主题2切换
          - 🌓 亮色/暗色模式
          - 🛠️ 12个界面定制功能
          - 💾 状态持久化
          
          ### 📝 更新日志
          查看 [README.md](https://github.com/SaXz2/orca-W95-theme/blob/main/README.md) 了解详细功能说明。
        files: orca-W95-theme-${{ github.ref_name }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
